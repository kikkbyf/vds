# 积分系统测试与跑通计划

## 目标
全流程验证积分系统，确保管理员侧和用户侧的显示及扣费逻辑正确无误，并修复发现的问题。

## 验证范围
1.  **用户侧**：
    -   **显示**：`Sidebar` 是否实时显示积分？
    -   **扣费**：生成图片时是否正确扣除 (4K=5, 2K=2, 1K=1)？
    -   **余额不足**：积分不足时是否有清晰提示？
2.  **管理员侧**：
    -   **修改积分**：`AdminPanelModal` 是否能增减用户积分？
    -   **日志**：是否能查看到扣费和管理员调整的记录？

## 拟定步骤
1.  **代码分析**：
    -   [ ] `src/store/useStudioStore.ts` (前端生成逻辑)
    -   [x] `src/app/api/py/[...path]/route.ts` (后端扣费逻辑)
    -   [x] `src/actions/user.ts` (用户积分查询)
2.  **修复/完善**：
    -   **[步骤 1] 错误处理优化**：确保前端能捕获 402 状态码并弹出"积分不足"提示。
    -   **[步骤 2] 实时更新**：生成成功后，立即更新前端积分显示 (无需等待 30秒轮询)。
    -   **[步骤 3] 管理员日志**：确保 `AdminPanelModal` 的日志视图能正确解析 `CreditLog`。

## 关键路径
用户点击生成 -> 此前检查积分 (可选) -> 调用 API -> API 扣费 -> 返回结果/错误 -> 前端处理 -> 更新积分显示

## 已解决问题 (Bug Fixes)
- [x] **图片生成后 404**：
    - **原因**：Next.js 静态文件索引在启动时构建，无法识别运行时生成的 `public/uploads` 新文件。
    - **解决**：新增动态路由 `/src/app/uploads/[filename]/route.ts`，直接读取磁盘文件并返回流，绕过静态缓存。
- [x] **Library 图片布局**：
    - **解决**：使用 Masonry 布局 + `width: 100%; height: auto;` 确保图片无拉伸、原比例展示。
- [x] **生成超时**：
    - **解决**：API 超时延长至 5 分钟，过时自动退款。
